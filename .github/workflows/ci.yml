name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    name: Test on ${{ matrix.os }} - Python ${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    # Only run on the original repository, not on forks
    if: github.repository == 'luohuan19/PTOTestingFramework'

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04]
        python-version: ['3.10']  # TODO: Re-enable 3.11 after fixing PyPTO TensorType API compatibility

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            ccache \
            git

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install numpy pytest pytest-xdist
          pip install nanobind

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ matrix.os }}-${{ matrix.python-version }}
          max-size: 500M

      - name: Cache dependencies
        id: cache-deps
        uses: actions/cache@v4
        with:
          path: |
            3rdparty/
            build/pypto/
          key: deps-${{ runner.os }}-${{ hashFiles('build_and_install.sh', '.github/workflows/ci.yml') }}-v2
          restore-keys: |
            deps-${{ runner.os }}-${{ hashFiles('build_and_install.sh', '.github/workflows/ci.yml') }}-
            deps-${{ runner.os }}-

      - name: Check for dependency updates
        if: steps.cache-deps.outputs.cache-hit == 'true'
        run: |
          echo "=== Checking for dependency updates ==="
          FORCE_REBUILD=false
          
          # Check for corrupted cache structures
          if [ -d "3rdparty/pypto" ] && [ ! -d "3rdparty/pypto/python" ]; then
            echo "âš ï¸  PyPTO cache corrupted (missing python/), cleaning..."
            rm -rf 3rdparty/pypto
            FORCE_REBUILD=true
          fi
          
          if [ -d "3rdparty/simpler" ] && [ ! -d "3rdparty/simpler/python" ]; then
            echo "âš ï¸  Simpler cache corrupted (missing python/), cleaning..."
            rm -rf 3rdparty/simpler
            FORCE_REBUILD=true
          fi
          
          # Check PyPTO updates
          if [ -d "3rdparty/pypto/.git" ]; then
            cd 3rdparty/pypto
            CURRENT_COMMIT=$(git rev-parse HEAD)
            git fetch origin main --depth=1
            LATEST_COMMIT=$(git rev-parse origin/main)
            if [ "$CURRENT_COMMIT" != "$LATEST_COMMIT" ]; then
              echo "âš ï¸  PyPTO has updates: $CURRENT_COMMIT -> $LATEST_COMMIT"
              FORCE_REBUILD=true
            else
              echo "âœ“ PyPTO is up-to-date: $CURRENT_COMMIT"
            fi
            cd ../..
          fi
          
          # Check Simpler updates
          if [ -d "3rdparty/simpler/.git" ]; then
            cd 3rdparty/simpler
            CURRENT_COMMIT=$(git rev-parse HEAD)
            git fetch origin main --depth=1
            LATEST_COMMIT=$(git rev-parse origin/main)
            if [ "$CURRENT_COMMIT" != "$LATEST_COMMIT" ]; then
              echo "âš ï¸  Simpler has updates: $CURRENT_COMMIT -> $LATEST_COMMIT"
              FORCE_REBUILD=true
            else
              echo "âœ“ Simpler is up-to-date: $CURRENT_COMMIT"
            fi
            cd ../..
          fi
          
          # Force rebuild if updates detected
          if [ "$FORCE_REBUILD" = true ]; then
            echo "ðŸ”„ Dependency updates detected - forcing rebuild"
            rm -rf 3rdparty/ build/pypto/
          else
            echo "âœ… All dependencies are up-to-date"
          fi

      - name: Build framework and dependencies
        run: |
          export PATH="/usr/lib/ccache:/usr/local/opt/ccache/libexec:$PATH"
          ./build_and_install.sh --install --type RelWithDebInfo --jobs $(nproc)

      - name: Source environment
        run: |
          source build/setup_env.sh
          echo "PYTHONPATH=$PYTHONPATH" >> $GITHUB_ENV
          echo "FRAMEWORK_ROOT=$FRAMEWORK_ROOT" >> $GITHUB_ENV
          echo "PYPTO_ROOT=$PYPTO_ROOT" >> $GITHUB_ENV
          echo "SIMPLER_ROOT=$SIMPLER_ROOT" >> $GITHUB_ENV

      - name: Display build information
        run: |
          echo "=== Build Information ==="
          echo "FRAMEWORK_ROOT: $FRAMEWORK_ROOT"
          echo "PYPTO_ROOT: ${PYPTO_ROOT:-not set}"
          echo "SIMPLER_ROOT: ${SIMPLER_ROOT:-not set}"
          echo ""
          echo "=== Dependency Status ==="
          if [ -n "$PYPTO_ROOT" ] && [ -d "$PYPTO_ROOT" ]; then
            echo "âœ“ PyPTO: $PYPTO_ROOT"
            echo "  Build artifacts:"
            find "$PYPTO_ROOT/python/pypto" -name "*.so" 2>/dev/null | head -n 1 || echo "  No .so files found"
          else
            echo "âœ— PyPTO not found"
          fi
          
          if [ -n "$SIMPLER_ROOT" ] && [ -d "$SIMPLER_ROOT" ]; then
            echo "âœ“ Simpler: $SIMPLER_ROOT"
          else
            echo "âœ— Simpler not found"
          fi

      - name: Verify installation
        run: |
          python -c "import pypto; print(f'PyPTO version: {pypto.__version__}')"
          python -c "import pto_compiler; print('Simpler modules accessible')"
          python -c "import pto_test; print(f'pto-test version: {pto_test.__version__}')"
          python -c "from pto_test.core import environment; print('Environment module OK')"

      # - name: Run tests (simulation mode)
      #   run: |
      #     pytest tests/ -v --tb=short --color=yes --platform=a2a3sim

      - name: Run tests with code generation only
        run: |
          pytest tests/ -v --codegen-only --save-kernels

      - name: Clean up test outputs on success
        if: success()
        run: |
          rm -rf build/outputs/

      - name: Upload test artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-outputs-${{ matrix.os }}-py${{ matrix.python-version }}
          path: build/outputs/
          retention-days: 7

      - name: Clean up test outputs on failure
        if: failure()
        run: |
          rm -rf build/outputs/

  lint:
    name: Code Quality Checks
    runs-on: ubuntu-22.04
    # Only run on the original repository, not on forks
    if: github.repository == 'luohuan19/PTOTestingFramework'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install black isort

      - name: Check code formatting with black
        run: |
          black --check --diff src/ tests/

      - name: Check import sorting with isort
        run: |
          isort --check-only --diff src/ tests/

  build-docs:
    name: Build Documentation
    runs-on: ubuntu-22.04
    # Only run on the original repository, not on forks
    if: github.repository == 'luohuan19/PTOTestingFramework'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify README
        run: |
          if [ ! -f README.md ]; then
            echo "README.md not found"
            exit 1
          fi
          echo "README.md exists and is valid"
