name: Update Submodules

on:
  schedule:
    # æ¯å¤©ä¸‰æ¬¡è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 08:00, 14:00, 20:00ï¼‰
    - cron: '0 0,6,12 * * *'  # UTC 00:00, 06:00, 12:00
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write
  pull-requests: write

jobs:
  update-submodules:
    name: Update Git Submodules
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update submodules to latest
        id: update
        run: |
          # è®°å½•æ›´æ–°å‰çš„çŠ¶æ€
          git submodule status > /tmp/submodule_status_before.txt

          # æ›´æ–°æ‰€æœ‰ submodules åˆ°è¿œç¨‹æœ€æ–°ç‰ˆæœ¬
          git submodule update --remote --recursive

          # è®°å½•æ›´æ–°åçš„çŠ¶æ€
          git submodule status > /tmp/submodule_status_after.txt

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          if ! diff /tmp/submodule_status_before.txt /tmp/submodule_status_after.txt > /dev/null; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Submodules have been updated"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No submodule updates available"
          fi

      - name: Get submodule changes summary
        if: steps.update.outputs.has_changes == 'true'
        id: changes
        run: |
          # ç”Ÿæˆå˜æ›´æ‘˜è¦
          SUMMARY=""

          # æ£€æŸ¥ pypto submodule
          cd 3rdparty/pypto
          PYPTO_OLD=$(git describe --always --tags HEAD@{1} 2>/dev/null || echo "unknown")
          PYPTO_NEW=$(git describe --always --tags HEAD 2>/dev/null || echo "unknown")
          if [ "$PYPTO_OLD" != "$PYPTO_NEW" ]; then
            SUMMARY="${SUMMARY}- PyPTO: ${PYPTO_OLD} -> ${PYPTO_NEW}\n"
          fi
          cd ../..

          # æ£€æŸ¥ simpler submodule
          cd 3rdparty/simpler
          SIMPLER_OLD=$(git describe --always --tags HEAD@{1} 2>/dev/null || echo "unknown")
          SIMPLER_NEW=$(git describe --always --tags HEAD 2>/dev/null || echo "unknown")
          if [ "$SIMPLER_OLD" != "$SIMPLER_NEW" ]; then
            SUMMARY="${SUMMARY}- Simpler: ${SIMPLER_OLD} -> ${SIMPLER_NEW}\n"
          fi
          cd ../..

          # ä¿å­˜æ‘˜è¦
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo -e "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.update.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            Bump all submodules

            Automated submodule update to latest versions:
            ${{ steps.changes.outputs.summary }}
          branch: auto-update-submodules
          delete-branch: true
          title: "chore: Update submodules to latest versions"
          body: |
            ## Automated Submodule Update

            This PR updates all submodules to their latest versions.

            ### Changes:
            ${{ steps.changes.outputs.summary }}

            ### Testing
            Please review the changes and ensure all tests pass before merging.

            ---
            ğŸ¤– Generated automatically by GitHub Actions
          labels: |
            dependencies
            automated
